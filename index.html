<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš½ å…±äº«èµ›ç¨‹æ—¥å†ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen flex items-center justify-center p-4">

<div id="app" class="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
    <div class="bg-blue-600 p-6 text-white text-center">
        <i class="fa-regular fa-calendar-check text-4xl mb-3"></i>
        <h1 class="text-2xl font-bold">èµ›ç¨‹æ—¥å†ç”Ÿæˆå™¨</h1>
        <p class="text-blue-100 text-sm mt-1">è‡ªåŠ¨åŒæ­¥æ”¹æœŸã€å»¶æœŸï¼Œæ°¸ä¸é”™è¿‡æ¯”èµ›</p>
    </div>

    <div class="p-6 space-y-5">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©è”èµ›</label>
            <select v-model="selectedLeague" @change="selectedTeam = ''" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition">
                <option value="" disabled>è¯·é€‰æ‹©è”èµ›...</option>
                <option v-for="(teams, league) in db" :key="league" :value="league">{{ league }}</option>
            </select>
        </div>

        <div v-if="selectedLeague">
            <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©çƒé˜Ÿ</label>
            <select v-model="selectedTeam" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition">
                <option value="" disabled>è¯·é€‰æ‹©çƒé˜Ÿ...</option>
                <option v-for="team in db[selectedLeague]" :key="team.id" :value="team">{{ team.name }}</option>
            </select>
        </div>

        <div v-if="selectedTeam" class="mt-4 border-t pt-4">
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider">è¿‘æœŸèµ›ç¨‹é¢„è§ˆ</p>
                <span v-if="isLoading" class="text-xs text-blue-500"><i class="fas fa-spinner fa-spin"></i> æŠ“å–ä¸­...</span>
            </div>
            <div v-if="previewMatches.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
                <div v-for="match in previewMatches" :key="match.uid" class="flex justify-between items-center p-2 bg-gray-50 rounded-lg border border-gray-100">
                    <span class="text-sm font-medium text-gray-700 truncate mr-2">{{ match.summary }}</span>
                    <span class="text-xs text-blue-600 whitespace-nowrap font-mono">{{ match.date }}</span>
                </div>
            </div>
            <div v-else-if="previewError && !isLoading" class="text-center py-4 text-red-500 text-xs">{{ previewError }}</div>
            <div v-else-if="!isLoading" class="text-center py-4 text-gray-400 text-xs italic">è¯¥çƒé˜Ÿæš‚æ— è¿‘æœŸèµ›ç¨‹æ•°æ®</div>
        </div>

        <div v-if="selectedTeam" class="mt-6 p-4 bg-blue-50 border border-blue-100 rounded-xl space-y-3">
            <p class="text-xs text-blue-700 font-semibold">å¯¼å…¥å…±äº«æ—¥å†</p>
            <div class="grid grid-cols-2 gap-3">
                <a :href="webcalUrl" class="block text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg shadow-md">
                    <i class="fa-brands fa-apple mr-1"></i> iOS/Mac
                </a>
                <a :href="googleCalendarUrl" target="_blank" rel="noopener" class="block text-center bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg shadow-md">
                    <i class="fa-brands fa-google mr-1"></i> Google
                </a>
                <a :href="outlookCalendarUrl" target="_blank" rel="noopener" class="block text-center bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-3 rounded-lg shadow-md">
                    <i class="fa-brands fa-microsoft mr-1"></i> Outlook
                </a>
                <a :href="downloadUrl" class="block text-center bg-white border border-blue-600 text-blue-700 font-medium py-3 rounded-lg hover:bg-blue-100 transition">
                    <i class="fa-solid fa-file-arrow-down mr-1"></i> ä¸‹è½½ ICS
                </a>
            </div>
            <div class="flex items-center space-x-2">
                <button @click="copyLink" class="bg-white border border-blue-600 text-blue-600 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition flex items-center">
                    <i class="fa-solid fa-link mr-1"></i> å¤åˆ¶è®¢é˜…é“¾æ¥
                </button>
                <span v-if="copySuccess" class="text-blue-600 text-sm select-none">é“¾æ¥å·²å¤åˆ¶</span>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, watch } = Vue;
    createApp({
        setup() {
            const calendarApiBase = "/api/calendar";
            const previewApiBase = "/api/preview";
            const selectedLeague = ref('');
            const selectedTeam = ref('');
            const previewMatches = ref([]);
            const previewError = ref('');
            const isLoading = ref(false);
            const copySuccess = ref(false);

            const createAbsolute = (path) => {
                if (!path) return '';
                if (path.startsWith('http://') || path.startsWith('https://')) return path;
                if (typeof window !== 'undefined' && window.location && window.location.origin && window.location.origin !== 'null') {
                  if (window.location.origin.startsWith('http://') || window.location.origin.startsWith('https://')) {
                    return `${window.location.origin}${path}`;
                  }
                }
                return `http://localhost:8000${path}`;
            };

            // æœ¬åœ°å†…ç½®çš„çƒé˜Ÿ ID æ•°æ®åº“ (åŸºäºæ‡‚çƒå¸)
            const db = ref({
                "ğŸ‡¨ğŸ‡³ ä¸­è¶…è”èµ›": [
                    { name: "æˆéƒ½è“‰åŸ", id: "50076899" },
                    { name: "äº‘å—ç‰æ˜†", id: "50117905" },
                    { name: "é’å²›è¥¿æµ·å²¸", id: "50093933" },
                    { name: "å¤§è¿è‹±åš", id: "50122423" },
                    { name: "æ·±åœ³æ–°é¹åŸ", id: "50053965" },
                    { name: "è¾½å®é“äºº", id: "50016400" },
                    { name: "é‡åº†é“œæ¢é¾™", id: "50122484" },
                    { name: "ä¸Šæµ·æµ·æ¸¯", id: "50007190" },
                    { name: "åŒ—äº¬å›½å®‰", id: "50000330" },
                    { name: "æµ™æ±Ÿ", id: "50000341" },
                    { name: "æ­¦æ±‰ä¸‰é•‡", id: "50077677" },
                    { name: "å±±ä¸œæ³°å±±", id: "50000335" },
                    { name: "æ²³å—", id: "50000339" },
                    { name: "é’å²›æµ·ç‰›", id: "50000328" },
                    { name: "ä¸Šæµ·ç”³èŠ±", id: "50000334" },
                    { name: "å¤©æ´¥æ´¥é—¨è™", id: "50000332" }
                ],
                "ğŸ‡¬ğŸ‡§ è‹±æ ¼å…°è¶…çº§è”èµ›": [
                    { name: "é˜¿æ£®çº³", id: "50000513" },
                    { name: "æ›¼åŸ", id: "50000529" },
                    { name: "é˜¿æ–¯é¡¿ç»´æ‹‰", id: "50000518" },
                    { name: "æ›¼è”", id: "50000515" },
                    { name: "åˆ‡å°”è¥¿", id: "50000514" },
                    { name: "åˆ©ç‰©æµ¦", id: "50000516" },
                    { name: "å¸ƒä¼¦ç‰¹ç¦å¾·", id: "50000575" },
                    { name: "åŸƒå¼—é¡¿", id: "50000527" },
                    { name: "ä¼¯æ©èŒ…æ–¯", id: "50000564" },
                    { name: "çº½å¡æ–¯å°”è”", id: "50000517" },
                    { name: "æ¡‘å¾·å…°", id: "50000536" },
                    { name: "å¯Œå‹’å§†", id: "50000520" },
                    { name: "æ°´æ™¶å®«", id: "50000532" },
                    { name: "å¸ƒè±é¡¿", id: "50000556" },
                    { name: "åˆ©å…¹è”", id: "50000534" },
                    { name: "æ‰˜ç‰¹çº³å§†çƒ­åˆº", id: "50000528" },
                    { name: "è¯ºä¸æ±‰æ£®æ—", id: "50000547" },
                    { name: "è¥¿æ±‰å§†è”", id: "50000537" },
                    { name: "ä¼¯æ©åˆ©", id: "50000551" },
                    { name: "ç‹¼é˜Ÿ", id: "50000533" }
                ],
                "ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™ç”²çº§è”èµ›": [
                    { "name": "çš‡å®¶é©¬å¾·é‡Œ", "id": "50001755" },
                    { "name": "å·´å¡ç½—é‚£", "id": "50001756" },
                    { "name": "é©¬å¾·é‡Œç«æŠ€", "id": "50001759" },
                    { "name": "æ¯”åˆ©äºšé›·äºšå°”", "id": "50001762" },
                    { "name": "çš‡å®¶è´è’‚æ–¯", "id": "50001764" },
                    { "name": "è¥¿ç­ç‰™äºº", "id": "50001771" },
                    { "name": "å¡å°”å¡”", "id": "50001772" },
                    { "name": "çš‡å®¶ç¤¾ä¼š", "id": "50001767" },
                    { "name": "å¥¥è¨è‹çº³", "id": "50001761" },
                    { "name": "èµ«å¡”è´¹", "id": "50001778" },
                    { "name": "æ¯•å°”å·´é„‚ç«æŠ€", "id": "50001758" },
                    { "name": "å¡ç»´åˆ©äºš", "id": "50001760" },
                    { "name": "é˜¿æ‹‰ç»´æ–¯", "id": "50001776" },
                    { "name": "èµ«ç½—çº³", "id": "50001836" },
                    { "name": "åŸƒå°”åˆ‡", "id": "50001782" },
                    { "name": "é©¬ç•¥å¡", "id": "50001766" },
                    { "name": "ç“¦ä¼¦è¥¿äºš", "id": "50001754" },
                    { "name": "å·´åˆ—å¡è¯º", "id": "50001793" },
                    { "name": "è±ä¸‡ç‰¹", "id": "50001775" },
                    { "name": "çš‡å®¶å¥¥ç»´è€¶å¤š", "id": "50002061" }
                ],
                "ğŸ‡©ğŸ‡ª å¾·å›½ç”²çº§è”èµ›": [
                    { "name": "æ‹œä»æ…•å°¼é»‘", "id": "50000804" },
                    { "name": "å¤šç‰¹è’™å¾·", "id": "50000807" },
                    { "name": "éœèŠ¬æµ·å§†", "id": "50000842" },
                    { "name": "æ–¯å›¾åŠ ç‰¹", "id": "50000805" },
                    { "name": "å‹’æ²ƒåº“æ£®", "id": "50000806" },
                    { "name": "RBè±æ¯”é”¡", "id": "50008568" },
                    { "name": "æ³•å…°å…‹ç¦", "id": "50000822" },
                    { "name": "å¼—èµ–å ¡", "id": "50000813" },
                    { "name": "æ±‰å ¡", "id": "50000810" },
                    { "name": "æŸæ—è”åˆ", "id": "50000860" },
                    { "name": "ç§‘éš†", "id": "50000823" },
                    { "name": "é—¨å…´æ ¼æ‹‰å¾·å·´èµ«", "id": "50000814" },
                    { "name": "å¥¥æ ¼æ–¯å ¡", "id": "50000841" },
                    { "name": "ç¾å› èŒ¨", "id": "50000820" },
                    { "name": "æ²ƒå°”å¤«æ–¯å ¡", "id": "50000811" },
                    { "name": "äº‘è¾¾ä¸è±æ¢…", "id": "50000803" },
                    { "name": "åœ£ä¿åˆ©", "id": "50000855" },
                    { "name": "æµ·ç™»æµ·å§†", "id": "50004404" }
                ],
                "ğŸ‡«ğŸ‡· æ³•å›½ç”²çº§è”èµ›": [
                    { "name": "æœ—æ–¯", "id": "50000737" },
                    { "name": "å·´é»åœ£æ—¥è€³æ›¼", "id": "50000731" },
                    { "name": "é‡Œæ˜‚", "id": "50000729" },
                    { "name": "é©¬èµ›", "id": "50000735" },
                    { "name": "é‡Œå°”", "id": "50000740" },
                    { "name": "é›·æ©", "id": "50000738" },
                    { "name": "æ–¯ç‰¹æ‹‰æ–¯å ¡", "id": "50000743" },
                    { "name": "æ‘©çº³å“¥", "id": "50000730" },
                    { "name": "å›¾å¢å…¹", "id": "50000744" },
                    { "name": "æ˜‚çƒ­", "id": "50000763" },
                    { "name": "æ´›é‡Œæ˜‚", "id": "50000752" },
                    { "name": "å¸ƒé›·æ–¯ç‰¹", "id": "50000767" },
                    { "name": "å‹’é˜¿å¼—å°”", "id": "50000757" },
                    { "name": "å°¼æ–¯", "id": "50000739" },
                    { "name": "å·´é»FC", "id": "50002258" },
                    { "name": "æ¬§å¡å°”", "id": "50000733" },
                    { "name": "å—ç‰¹", "id": "50000734" },
                    { "name": "æ¢…æ–¯", "id": "50000741" }
                ],
                "ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©ç”²çº§è”èµ›": [
                    { "name": "å›½é™…ç±³å…°", "id": "50001042" },
                    { "name": "ACç±³å…°", "id": "50001038" },
                    { "name": "é‚£ä¸å‹’æ–¯", "id": "50001068" },
                    { "name": "å°¤æ–‡å›¾æ–¯", "id": "50001040" },
                    { "name": "ç½—é©¬", "id": "50001039" },
                    { "name": "äºšç‰¹å…°å¤§", "id": "50001053" },
                    { "name": "ç§‘è«", "id": "50001081" },
                    { "name": "æ‹‰é½å¥¥", "id": "50001043" },
                    { "name": "ä¹Œè¿ªå†…æ–¯", "id": "50001044" },
                    { "name": "åšæ´›å°¼äºš", "id": "50001047" },
                    { "name": "è¨ç´¢æ´›", "id": "50004293" },
                    { "name": "å¡åˆ©äºšé‡Œ", "id": "50001054" },
                    { "name": "éƒ½çµ", "id": "50001066" },
                    { "name": "å¸•å°”é©¬", "id": "50001041" },
                    { "name": "çƒ­é‚£äºš", "id": "50001074" },
                    { "name": "å…‹é›·è«å†…å¡", "id": "50002065" },
                    { "name": "ä½›ç½—ä¼¦è¨", "id": "50001057" },
                    { "name": "è±åˆ‡", "id": "50001049" },
                    { "name": "æ¯”è¨", "id": "50001088" },
                    { "name": "ç»´ç½—çº³", "id": "50001075" }
                ]
            });
            
            const generateUrl = computed(() => {
                if (!selectedTeam.value) return '';
                return `${calendarApiBase}?team_id=${selectedTeam.value.id}&team_name=${encodeURIComponent(selectedTeam.value.name)}&allow_fallback=1`;
            });

            const fullUrl = computed(() => createAbsolute(generateUrl.value));
            const downloadUrl = computed(() => {
                if (!generateUrl.value) return '';
                return `${generateUrl.value}&download=1`;
            });

            const webcalUrl = computed(() => {
                if (!fullUrl.value) return '';
                return fullUrl.value.replace(/^https?:/, 'webcal:');
            });

            const googleCalendarUrl = computed(() => {
                if (!fullUrl.value) return '';
                return `https://calendar.google.com/calendar/u/0/r?cid=${encodeURIComponent(fullUrl.value)}`;
            });

            const outlookCalendarUrl = computed(() => {
                if (!fullUrl.value || !selectedTeam.value) return '';
                return `https://outlook.live.com/calendar/0/addcalendar?url=${encodeURIComponent(fullUrl.value)}&name=${encodeURIComponent(selectedTeam.value.name + ' èµ›ç¨‹')}`;
            });

            const previewUrl = computed(() => {
                if (!selectedTeam.value) return '';
                return `${previewApiBase}?team_id=${selectedTeam.value.id}&team_name=${encodeURIComponent(selectedTeam.value.name)}&limit=8`;
            });

            const fetchPreview = async (url) => {
                isLoading.value = true;
                previewError.value = '';
                const requestUrl = createAbsolute(url);
                const isFileMode = typeof window !== 'undefined' && window.location && window.location.origin === 'null';
                try {
                    const response = await fetch(requestUrl);
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        const msg = data.message || data.error || `é¢„è§ˆæ¥å£å¼‚å¸¸ (${response.status})`;
                        throw new Error(msg);
                    }
                    previewMatches.value = (data.matches || []).map((item, idx) => ({
                        summary: item.summary,
                        date: item.date,
                        uid: `${item.start_iso || item.date}-${idx}`
                    }));
                } catch (e) {
                    console.error("æŠ“å–é¢„è§ˆå¤±è´¥", e);
                    const msg = e?.message || '';
                    if (msg === 'Failed to fetch') {
                        if (isFileMode) {
                            previewError.value = 'å½“å‰æ˜¯ file:// æ‰“å¼€ï¼Œè¯·å…ˆå¯åŠ¨åç«¯ http://localhost:8000ï¼ˆå‘½ä»¤ï¼šuvicorn main:app --reloadï¼‰';
                        } else {
                            previewError.value = `æ— æ³•è¿æ¥åˆ°æ¥å£ï¼Œè¯·ç¡®è®¤å¯è®¿é—® ${createAbsolute('/api/health')}`;
                        }
                    } else {
                        previewError.value = msg || 'æŠ“å–èµ›ç¨‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    }
                } finally { isLoading.value = false; }
            };

            watch(selectedTeam, (newTeam) => {
                previewMatches.value = [];
                previewError.value = '';
                if (newTeam) fetchPreview(previewUrl.value);
            });

            const copyLink = () => {
                if (!fullUrl.value) return;
                navigator.clipboard.writeText(fullUrl.value);
                copySuccess.value = true;
                setTimeout(() => {
                    copySuccess.value = false;
                }, 2000);
            };

            return {
                db,
                selectedLeague,
                selectedTeam,
                webcalUrl,
                googleCalendarUrl,
                outlookCalendarUrl,
                downloadUrl,
                copyLink,
                previewMatches,
                previewError,
                isLoading,
                copySuccess
            }
        }
    }).mount('#app');
</script>
</body>
</html>
